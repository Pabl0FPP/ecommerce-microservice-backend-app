name: Deploy Dev (kind local)

on:
  workflow_dispatch:
  push:
    branches: [ develop ]

env:
  K8S_NAMESPACE: default
  KIND_VERSION: v0.20.0

jobs:
  deploy-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Create kind cluster
        run: |
          kind create cluster --name ecommerce --config kind-cluster-config.yaml || true
          kubectl cluster-info --context kind-ecommerce

      - name: Wait for kind cluster to be ready
        run: |
          kubectl wait --for=condition=ready nodes --all --timeout=300s

      - name: Load Docker images into kind (if needed)
        run: |
          # Si las im치genes est치n en Docker Hub, kind las descargar치 autom치ticamente
          # Si necesitas cargar im치genes locales, descomenta:
          # kind load docker-image selimhorri/service-discovery-ecommerce-boot:0.1.0 --name ecommerce || true
          # kind load docker-image selimhorri/cloud-config-ecommerce-boot:0.1.0 --name ecommerce || true
          # kind load docker-image openzipkin/zipkin:latest --name ecommerce || true
          echo "Images will be pulled from Docker Hub automatically"

      - name: Apply core manifests
        run: |
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/cloud-config-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/eureka-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/zipkin-deployment.yml

      - name: Wait core ready
        run: |
          kubectl rollout status -n "$K8S_NAMESPACE" deploy/cloud-config --timeout=10m || echo "Cloud Config may still be starting"
          kubectl rollout status -n "$K8S_NAMESPACE" deploy/service-discovery --timeout=10m || echo "Service Discovery may still be starting"

      - name: Show core services status
        run: |
          kubectl get pods -n "$K8S_NAMESPACE"
          kubectl get svc -n "$K8S_NAMESPACE" | grep -E "(NAME|cloud-config|service-discovery|zipkin)"

  deploy-services:
    runs-on: ubuntu-latest
    needs: deploy-core
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Create kind cluster (if not exists)
        run: |
          # Nota: Cada job corre en un runner diferente, as칤 que necesitamos crear el cluster de nuevo
          # En un entorno real, podr칤as usar un runner compartido o un cluster persistente
          kind create cluster --name ecommerce --config kind-cluster-config.yaml || true
          kubectl cluster-info --context kind-ecommerce

      - name: Load Docker images into kind (if needed)
        run: |
          # Si las im치genes est치n en Docker Hub, kind las descargar치 autom치ticamente
          # Si necesitas cargar im치genes locales, descomenta:
          # kind load docker-image pablofpp/api-gateway:0.1.0 --name ecommerce || true
          # kind load docker-image pablofpp/user-service:0.1.0 --name ecommerce || true
          # ... etc
          echo "Images will be pulled from Docker Hub automatically"

      - name: Apply service manifests
        run: |
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/api-gateway-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/user-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/product-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/order-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/payment-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/shipping-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/favourite-deployment.yml
          kubectl apply -n "$K8S_NAMESPACE" -f k8s/proxy-client-deployment.yml

      - name: Wait services ready
        shell: bash
        run: |
          set +e  # No fallar si alg칰n servicio tarda m치s
          for d in api-gateway user-service product-service order-service payment-service shipping-service favourite-service proxy-client; do
            echo "Waiting for $d rollout..."
            kubectl rollout status -n "$K8S_NAMESPACE" deploy/$d --timeout=10m || echo "丘멆잺  $d may still be starting"
          done

      - name: Show all services status
        run: |
          echo "游늶 Pods status:"
          kubectl get pods -n "$K8S_NAMESPACE"
          echo ""
          echo "游늶 Services with NodePort:"
          kubectl get svc -n "$K8S_NAMESPACE" -o wide | grep NodePort
          echo ""
          echo "游눠 Services are accessible at:"
          echo "   - localhost:<NodePort> (from within the runner)"
          echo "   - Services use NodePort type for external access"

      - name: Show service URLs
        run: |
          echo "游댌 Service URLs (NodePort):"
          kubectl get svc -n "$K8S_NAMESPACE" -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.type}{"\t"}{.spec.ports[0].nodePort}{"\n"}{end}' | grep NodePort | awk '{print "  - " $1 ": http://localhost:" $3}'

